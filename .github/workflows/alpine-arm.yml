name: Build and Test alpine ARM instance

on:
  push:

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout


jobs:

  test:
    runs-on: ubuntu24-arm64-4-16 # ubuntu24-arm64-2-8
    container:
      image: alpine:3 # arm64v8/alpine # required to run the job on the ARM instance
    steps:
      - name: Workaround alpine-arm64 GHA issues
        shell: sh
        run: |
          cp /etc/os-release /etc/os-release.bak
          sed -i 's/ID=alpine/ID=NotpineForGHA/g' /etc/os-release
      - name: Install prerequisites
        shell: sh
        run: |
          echo ::group::install packages
          apk add bash make libtool tar cmake python3 python3-dev \
          py3-pip gcc git curl build-base autoconf automake py3-cryptography \
          linux-headers musl-dev libffi-dev openssl-dev openssh py-virtualenv \
          clang18-libclang gcompat libstdc++ libgcc g++ openblas-dev \
          xsimd git xz bsd-compat-headers clang18
          echo ::endgroup::
      - name: Checkout the module
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Install python dependencies
        run: |
          pip install -q --upgrade pip setuptools wheel
          pip install -q -r tests/flow/requirements.txt
          pip install -q jinja2 ramp-packer
        env:
          PIP_BREAK_SYSTEM_PACKAGES: 1
      - name: Checkout Redis
        uses: actions/checkout@v3
        with:
          repository: 'redis/redis'
          ref: ${{ matrix.redis-version }}
          path: 'redis'
      - name: Build Redis
        working-directory: redis
        shell: sh
        run: |
          make -j `nproc`
          echo "REDIS_SERVER=$GITHUB_WORKSPACE/redis/src/redis-server" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/redis/src" >> $GITHUB_PATH
          export PATH="$GITHUB_WORKSPACE/redis/src:$PATH"
          redis-server --version
      - name: Build module
        shell: sh
        run: |
          make build
      - name: Test
        shell: sh
        run: |
          make test
      - name: Pack module
        shell: sh
        run: |
          make pack BRANCH=${{ github.ref_name }}